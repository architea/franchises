---
import { useStoryblokApi } from "@storyblok/astro"
import isPreview from "../utils/isPreview"
import { Image } from "astro:assets"
import RichText from "./utils/RichText.astro"
import InlineSvg from "./utils/InlineSvg.astro"
import Button from "./Button.astro"

const storyblokApi = useStoryblokApi()
const { data } = await storyblokApi.get(`cdn/stories/global`, {
  version: isPreview() ? "draft" : "published",
  resolve_links: "url",
  resolve_links_level: 2
})

const footerdata = data.story.content

const datanav = data.story.content.navitems
let nav
if (datanav) {
  nav = datanav.map((item: any) => {
    return {
      name: item.name,
      url: item.page.story?.full_slug,
      subpages: item.subpages.map((subpage: any) => {
        return {
          name: subpage.name,
          url: subpage.page.story?.full_slug
        }
      })
    }
  })
}
---

<footer>
  <div class="infos">
    {footerdata.infosfooter && <RichText content={footerdata.infosfooter} />}
    {
      footerdata.logofooter?.filename && (
        <Image
          src={footerdata.logofooter.filename}
          alt={footerdata.logofooter.alt || " "}
          layout="full-width"
          inferSize
          class="mt-(--space-m)"
        />
      )
    }
  </div>
  <div class="nav">
    <ul>
      {
        nav &&
          nav.map((item: any) => (
            <li class="relative">
              {item.url && (
                <a
                  href={`/${item.url}`}
                  title={item.name}
                  aria-label={item.name}
                  class="relative page">
                  {item.name}
                </a>
              )}
              {!item.url && <span class="page">{item.name}</span>}
              {item.subpages && (
                <ul>
                  {item.subpages.map((subitem: any) => (
                    <li>
                      <a
                        href={`/${subitem.url}`}
                        title={subitem.name}
                        aria-label={subitem.name}
                        class="subpage">
                        {subitem.name}
                      </a>
                    </li>
                  ))}
                </ul>
              )}
            </li>
          ))
      }
    </ul>
  </div>
  <div class="image">
    {
      footerdata.image?.filename && (
        <Image
          src={footerdata.image.filename}
          alt={footerdata.image.alt || " "}
          layout="full-width"
          inferSize
          class="mx-auto max-h-80 w-auto"
        />
      )
    }
  </div>
  <div class="slogan flex flex-col gap-5 self-center">
    <div class="self-start max-w-[40ch]">
      <RichText content={footerdata.slogan} />
    </div>
    <div
      class="w-full flex flex-wrap gap-(--space-m) items-center justify-between">
      <div class="rs flex flex-wrap gap-5">
        {
          footerdata.rs.map((reseau: any) => (
            <a
              href={reseau.url.url}
              class={`icones-social-12 ${reseau.name}`}
              rel="external noopener noreferrer"
              title={`Voir notre page ${reseau.name} ArchitÃ©a`}
              target="_blank"
              aria-label={`lien vers ${reseau.name}`}>
              <InlineSvg
                src={reseau.icon.filename}
                class={`rs-icon fill-${reseau.color}`}
              />
            </a>
          ))
        }
      </div>
      {footerdata.button.length != 0 && <Button blok={footerdata.button[0]} />}
    </div>
  </div>
</footer>

<style>
  @reference "../styles/global.css";

  footer {
    background-color: var(--color-noir);
    color: var(--color-blanc);
    @apply px-5 lg:px-10 py-(--space-xl);
    display: flex;
    flex-wrap: wrap;
    justify-content: space-around;
    align-items: flex-start;
    gap: var(--space-m);
  }
  .infos {
    align-self: self-start;
    @apply basis-full sm:basis-[20%] xl:basis-[15%];
  }
  .infos :global(p + p) {
    margin-block-start: 0;
  }
  .infos :global(p:first-child) {
    font-size: var(--step-1);
    margin-block-end: var(--space-xs);
  }
  .nav {
    @apply basis-full sm:basis-[15%];
  }
  .nav .page {
    font-size: var(--step-1);
    font-weight: 700;
  }
  .nav .subpage {
    padding-inline-start: var(--space-xs);
  }
  .image {
    align-self: center;
    @apply order-4 lg:order-3 block basis-full sm:basis-1/2 lg:basis-[20%] md:hidden xl:block;
  }
  .slogan {
    font-size: var(--step-1);
    @apply basis-full sm:basis-1/2 md:basis-[40%] order-3 lg:order-4 lg:basis-full xl:basis-[40%];
  }
</style>
